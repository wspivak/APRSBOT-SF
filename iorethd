#!/usr/bin/env python3
import sys, logging, time, signal, os
from logging.handlers import RotatingFileHandler
from ioreth.bot import ReplyBot

LOG_PATH = "/opt/aprsbot/logs/replybot.log"
os.makedirs(os.path.dirname(LOG_PATH), exist_ok=True)

root = logging.getLogger()
root.handlers.clear()
root.setLevel(logging.DEBUG)

fh = RotatingFileHandler(LOG_PATH, maxBytes=5_000_000, backupCount=5)
fh.setLevel(logging.INFO)
fh.setFormatter(logging.Formatter("%(asctime)s %(levelname)s: %(funcName)s %(message)s"))
root.addHandler(fh)

logging.captureWarnings(True)
logger = logging.getLogger(__name__)

should_run = True
def shutdown(signum, frame):
    global should_run
    logger.info("Shutdown signal received, stopping bot loop.")
    should_run = False

signal.signal(signal.SIGINT, shutdown)
signal.signal(signal.SIGTERM, shutdown)

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print(f"Usage: {sys.argv[0]} <config-file.conf>")
        sys.exit(1)

    try:
        b = ReplyBot(sys.argv[1])
    except Exception:
        logger.exception("Failed to initialize ReplyBot")
        sys.exit(1)

    logger.info("Bot initialized, entering main loop")
    while should_run:
        try:
            b.on_loop_hook()
            time.sleep(1)
        except Exception:
            logger.exception("Fatal error in bot loop")
            time.sleep(3)

    logger.info("Bot shutdown complete.")
